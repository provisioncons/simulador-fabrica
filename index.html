<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador de Fábrica por Dados — Standalone</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const MEAN_DIE = 3.5;
    function mulberry32(seed) {
      let t = seed >>> 0;
      return function () {
        t += 0x6D2B79F5;
        let r = Math.imul(t ^ (t >>> 15), 1 | t);
        r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
        return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
      };
    }

    const defaultParams = {
      fator: [2,2,2,1,2,2],
      estoqueInicial: [0,0,0,0,0],
      preco: 4,
      custoVariavel: 0,
      custoFixo: 0,
      custoInventario: 0,
      politica: { modo: "livre", gargalo: 4, bufferAlvoDias: 3 },
      semente: 12345,
      ltMetodo: 1,
      ltTransfer: 1,
      ltMcRuns: 200,
    };

    function diasParaPecas(p) {
      const k = p.politica.gargalo - 1;
      const mediaCap = MEAN_DIE * (p.fator[k] ?? 1);
      const alvo = p.politica.bufferAlvoPecas ?? Math.round((p.politica.bufferAlvoDias ?? 0) * mediaCap);
      return Math.max(0, alvo);
    }

    function estadoInicial(p) {
      const visIni = [Infinity, ...p.estoqueInicial];
      return {
        rodada: 0,
        dados: [0,0,0,0,0,0],
        capacidade: [0,0,0,0,0,0],
        estoqueAntes: visIni.slice(),
        producao: [0,0,0,0,0,0],
        estoqueDepois: visIni.slice(),
        visAntes: visIni.slice(),
        th: 0, thAcum: 0,
        wip: p.estoqueInicial.reduce((a,b)=>a+b,0),
        leadTime: 0,
        ganho: 0, inv: 0, do: 0, lucro: 0
      };
    }

    function capacidadeMedia(f) { return MEAN_DIE * f; }
    function calcularLeadTime(p, ctx) {
      const metodo = p.ltMetodo ?? 1;
      const transfer = p.ltTransfer ?? 1;
      const N = 6;
      if (metodo === 1) { return ctx.thMedio > 0 ? ctx.wip / ctx.thMedio : 0; }
      if (metodo === 2) {
        let total = 0;
        for (let i=0;i<N;i++) {
          const mu = Math.max(1e-6, capacidadeMedia(p.fator[i] ?? 1));
          const Q = i===0
            ? (p.politica.modo === "restricao" ? (Number.isFinite(ctx.visAntes[0]) ? ctx.visAntes[0] : 0) : 0)
            : (Number.isFinite(ctx.visAntes[i]) ? ctx.visAntes[i] : 0);
          total += (Q/mu) + (1/mu) + (i < N-1 ? transfer : 0);
        }
        return total;
      }
      if (metodo === 3) {
        const sumFor = (capPerFace) => {
          let tot = 0;
          for (let i=0;i<N;i++) {
            const mu = Math.max(1e-6, capPerFace * (p.fator[i] ?? 1));
            const Q = i===0
              ? (p.politica.modo === "restricao" ? (Number.isFinite(ctx.visAntes[0]) ? ctx.visAntes[0] : 0) : 0)
              : (Number.isFinite(ctx.visAntes[i]) ? ctx.visAntes[i] : 0);
            tot += (Q/mu) + (1/mu) + (i < N-1 ? transfer : 0);
          }
          return tot;
        };
        const ltMin = sumFor(6), ltMax = sumFor(1);
        return (ltMin + ltMax) / 2;
      }
      if (metodo === 4) {
        const runs = Math.max(10, p.ltMcRuns ?? 200);
        const localRng = mulberry32((p.semente ?? 1) + 987654321);
        const sampleOne = () => {
          let t = 0;
          for (let i=0;i<N;i++) {
            const fator = p.fator[i] ?? 1;
            const Q = (i===0) ? 0 : (Number.isFinite(ctx.visAntes[i]) ? ctx.visAntes[i] : 0);
            let restante = Q + 1;
            while (restante > 0) {
              const cap = (1 + Math.floor(localRng()*6)) * fator;
              const proc = Math.min(restante, cap);
              restante -= proc;
              t += 1;
              if (restante <= 0 && i < N-1) t += transfer;
            }
          }
          return t;
        };
        let acc = 0;
        for (let r=0;r<runs;r++) acc += sampleOne();
        return acc / runs;
      }
      return ctx.thMedio > 0 ? ctx.wip / ctx.thMedio : 0;
    }

    function passo(p, s, rng) {
      const dados = Array.from({length:6}, () => 1 + Math.floor(rng()*6));
      const cap = dados.map((d,i)=> Math.floor(d * p.fator[i]));

      const estoqueInicial = [...s.estoqueAntes];

      let liberar = 0;
      let estoque0 = Infinity;
      if (p.politica.modo === "restricao") {
        const k = p.politica.gargalo - 1;
        const alvo = diasParaPecas(p);
        const bufAtual = Number.isFinite(estoqueInicial[k]) ? estoqueInicial[k] : 0;
        liberar = Math.max(0, alvo - bufAtual);
        cap[0] = Math.min(cap[0], liberar);
        estoque0 = liberar;
      }

      const X = Array(6).fill(0);
      const estoqueFinal = [...estoqueInicial];

      X[0] = Math.min(cap[0], Number.isFinite(estoque0) ? estoque0 : cap[0]);
      const finalM1 = p.politica.modo === "restricao" ? Math.max(0, (estoque0) - X[0]) : Infinity;

      for (let i=1;i<6;i++) {
        const disp = Number.isFinite(estoqueInicial[i]) ? estoqueInicial[i] : 0;
        const prod = Math.min(cap[i], disp);
        X[i] = prod;
        estoqueFinal[i] = disp - prod;
      }
      estoqueFinal[0] = finalM1;

      const proxAntes = [...estoqueFinal];
      for (let i=1;i<6;i++) {
        const add = X[i-1];
        proxAntes[i] = (Number.isFinite(proxAntes[i]) ? proxAntes[i] : 0) + add;
      }
      proxAntes[0] = p.politica.modo === "restricao" ? finalM1 : Infinity;

      const th = X[5];
      const thAcum = s.thAcum + th;
      const wip = (estoqueFinal.slice(1)).reduce((a,b)=> a + (Number.isFinite(b) ? b : 0), 0);
      const thMedio = thAcum / (s.rodada + 1);
      const lead = calcularLeadTime(p, { wip, thMedio, visAntes: estoqueInicial });

      const ganho = s.ganho + p.preco * th;
      const inv = s.inv + p.custoInventario * wip;
      const DO = s.do + p.custoFixo;
      const lucro = ganho - DO - inv - p.custoVariavel * thAcum;

      return {
        rodada: s.rodada + 1, dados, capacidade: cap,
        estoqueAntes: proxAntes, producao: X, estoqueDepois: estoqueFinal, visAntes: estoqueInicial,
        th, thAcum, wip, leadTime: lead, ganho, inv, do: DO, lucro
      };
    }

    function NumberInput({ label, value, onChange, step = 1, min = 0 }) {
      return (
        <label className="flex items-center justify-between gap-2 text-sm py-1">
          <span className="text-gray-700">{label}</span>
          <input type="number" className="w-24 rounded border px-2 py-1 text-right"
                 step={step} min={min} value={Number.isFinite(value) ? value : 0}
                 onChange={(e)=>onChange(parseFloat(e.target.value))}/>
        </label>
      );
    }

    function Row({ label, children }) {
      return (
        <div>
          <div className="text-xs text-gray-500 mb-1">{label}</div>
          <div className="grid grid-cols-6 gap-2">{children}</div>
        </div>
      );
    }

    function Cell({ value, infinity=false, muted=false }) {
      const display = infinity ? "∞" : (Number.isFinite(value) ? Math.max(0, Math.floor(value)).toString() : "∞");
      return (
        <div className={\`rounded-xl border px-2 py-3 text-center \${muted ? "bg-gray-50 text-gray-400" : "bg-yellow-50"}\`}>
          <div className="font-mono">{display}</div>
        </div>
      );
    }

    function Metric({ label, value, precision = 0 }) {
      return (
        <div className="rounded-xl bg-gray-50 p-3 text-center border">
          <div className="text-xs text-gray-500">{label}</div>
          <div className="text-lg font-semibold font-mono">{Number(value).toFixed(precision)}</div>
        </div>
      );
    }

    function App() {
      const [params, setParams] = useState({...defaultParams});
      const [estado, setEstado] = useState(estadoInicial({...defaultParams}));
      const [rodarN, setRodarN] = useState(1);
      const [autoplay, setAutoplay] = useState(false);
      const rngRef = useRef(()=>Math.random());

      useEffect(()=>{ rngRef.current = mulberry32(params.semente); }, [params.semente]);

      function aplicarParametros(next) {
        const p = { ...params, ...next };
        setParams(p);
        setEstado(estadoInicial(p));
        setAutoplay(false);
      }
      function aplicarParametrosSoft(next) {
        const p = { ...params, ...next };
        setParams(p);
        if (next.politica) {
          setEstado(prev => {
            const alvo = p.politica.modo === "restricao" ? diasParaPecas(p) : Infinity;
            const vis0 = alvo;
            return { ...prev, visAntes: [vis0, ...((prev.visAntes?.slice(1)) || [0,0,0,0,0])] };
          });
        }
      }
      function rodarPasso(){ setEstado(s => passo(params, s, rngRef.current)); }
      function rodarNLote(n){ for(let i=0;i<n;i++) rodarPasso(); }
      useEffect(()=>{ if(!autoplay) return; const id=setInterval(()=>rodarPasso(),120); return ()=>clearInterval(id); }, [autoplay, params]);

      const buffers = (estado.visAntes?.slice(1)) || [];
      const producao = estado.producao;
      const dados = estado.dados;

      return (
        <div className="min-h-screen bg-gray-100 text-gray-900">
          <div className="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4 p-4">
            <aside className="bg-white rounded-2xl shadow p-4 space-y-3">
              <h2 className="text-lg font-semibold">Parâmetros</h2>

              <div className="space-y-1">
                <div className="text-sm font-medium text-gray-600">Fator por máquina</div>
                {params.fator.map((v,i)=>(
                  <NumberInput key={i} label={\`Máquina \${i+1}\`} value={v} step={0.1} min={0}
                    onChange={(x)=>aplicarParametros({ fator: params.fator.map((fv,idx)=> idx===i ? x : fv) })}/>
                ))}
              </div>

              <div className="space-y-1">
                <div className="text-sm font-medium text-gray-600">Estoque inicial (antes de M2..M6)</div>
                {params.estoqueInicial.map((v,i)=>(
                  <NumberInput key={i} label={\`Buffer \${i+2}\`} value={v} step={1} min={0}
                    onChange={(x)=>aplicarParametros({ estoqueInicial: params.estoqueInicial.map((ev,idx)=> idx===i ? Math.max(0, Math.floor(x)) : ev) })}/>
                ))}
              </div>

              <div className="space-y-1">
                <div className="text-sm font-medium text-gray-600">Política</div>
                <div className="flex items-center gap-2">
                  <select className="border rounded px-2 py-1" value={params.politica.modo}
                          onChange={(e)=>aplicarParametrosSoft({ politica:{ ...params.politica, modo:e.target.value } })}>
                    <option value="livre">Livre (push)</option>
                    <option value="restricao">Subordinar à restrição (DBR)</option>
                  </select>
                  <label className="text-sm">Gargalo:</label>
                  <select className="border rounded px-2 py-1" value={params.politica.gargalo}
                          onChange={(e)=>aplicarParametrosSoft({ politica:{ ...params.politica, gargalo: parseInt(e.target.value,10) } })}>
                    {[1,2,3,4,5,6].map(n=> <option key={n} value={n}>{\`M\${n}\`}</option>)}
                  </select>
                </div>
                <NumberInput label="Buffer-alvo (dias)" value={params.politica.bufferAlvoDias ?? 0} step={0.5}
                  onChange={(x)=>aplicarParametrosSoft({ politica:{ ...params.politica, bufferAlvoDias:x, bufferAlvoPecas: undefined } })}/>
                <NumberInput label="Buffer-alvo (peças)" value={params.politica.bufferAlvoPecas ?? 0} step={1}
                  onChange={(x)=>aplicarParametrosSoft({ politica:{ ...params.politica, bufferAlvoPecas: Math.max(0, Math.floor(x)) } })}/>
              </div>

              <div className="space-y-1">
                <div className="text-sm font-medium text-gray-600">Lead time – método</div>
                <div className="flex items-center gap-2">
                  <select className="border rounded px-2 py-1" value={params.ltMetodo ?? 1}
                          onChange={(e)=>aplicarParametros({ ltMetodo: parseInt(e.target.value,10) })}>
                    <option value={1}>1) Little (WIP/TH médio)</option>
                    <option value={2}>2) Estágios (Σ fila/μ + 1/μ + transf)</option>
                    <option value={3}>3) Janela min–max (média)</option>
                    <option value={4}>4) Monte Carlo</option>
                  </select>
                </div>
                <NumberInput label="Atraso entre estágios (rodadas)" value={params.ltTransfer ?? 1} step={1}
                  onChange={(x)=>aplicarParametros({ ltTransfer: Math.max(0, Math.floor(x)) })}/>
                {(params.ltMetodo ?? 1) === 4 && (
                  <NumberInput label="Simulações Monte Carlo" value={params.ltMcRuns ?? 200} step={50}
                    onChange={(x)=>aplicarParametros({ ltMcRuns: Math.max(10, Math.floor(x)) })}/>
                )}
              </div>

              <div className="space-y-1">
                <div className="text-sm font-medium text-gray-600">Economia</div>
                <NumberInput label="Preço de venda (p)" value={params.preco} step={0.5}
                  onChange={(x)=>aplicarParametros({ preco:x })}/>
                <NumberInput label="Custo variável (cv)" value={params.custoVariavel} step={0.5}
                  onChange={(x)=>aplicarParametros({ custoVariavel:x })}/>
                <NumberInput label="Custo fixo por rodada (cf)" value={params.custoFixo} step={0.5}
                  onChange={(x)=>aplicarParametros({ custoFixo:x })}/>
                <NumberInput label="Custo de inventário (h)" value={params.custoInventario} step={0.1}
                  onChange={(x)=>aplicarParametros({ custoInventario:x })}/>
              </div>

              <div className="space-y-1">
                <div className="text-sm font-medium text-gray-600">Outros</div>
                <NumberInput label="Semente RNG" value={params.semente} step={1}
                  onChange={(x)=>aplicarParametros({ semente: Math.floor(x) })}/>
              </div>
            </aside>

            <main className="bg-white rounded-2xl shadow p-4">
              <div className="flex items-center justify-between">
                <h1 className="text-xl font-semibold">Fábrica (Jogo dos Dados)</h1>
                <div className="flex items-center gap-2">
                  <button onClick={()=>setAutoplay(a=>!a)} className={\`px-3 py-1 rounded text-sm \${autoplay ? "bg-red-500 text-white" : "bg-emerald-500 text-white"}\`}>{autoplay ? "Pausar" : "Autoplay"}</button>
                  <button onClick={()=>rodarPasso()} className="px-3 py-1 rounded bg-blue-600 text-white text-sm">Rodar 1</button>
                  <div className="flex items-center gap-2">
                    <input type="number" value={rodarN} onChange={(e)=>setRodarN(Math.max(1, parseInt(e.target.value||"1",10)))} className="w-20 border rounded px-2 py-1 text-right text-sm"/>
                    <button onClick={()=>rodarNLote(rodarN)} className="px-3 py-1 rounded bg-blue-100 hover:bg-blue-200 text-sm">Rodar N</button>
                  </div>
                  <button onClick={()=>{ setEstado(estadoInicial(params)); setAutoplay(false); }} className="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">Recomeçar</button>
                </div>
              </div>

              <div className="grid grid-cols-2 md:grid-cols-6 gap-3 mt-4">
                <Metric label="Rodada" value={estado.rodada}/>
                <Metric label={\`Lead time (método \${params.ltMetodo ?? 1})\`} value={estado.leadTime} precision={2}/>
                <Metric label="TH médio" value={estado.rodada ? estado.thAcum/estado.rodada : 0} precision={3}/>
                <Metric label="WIP" value={estado.wip}/>
                <Metric label="Ganho (R$)" value={estado.ganho} precision={2}/>
                <Metric label="Lucro (R$)" value={estado.lucro} precision={2}/>
              </div>

              <div className="mt-4">
                <div className="grid grid-cols-6 gap-2">
                  {Array.from({length:6}).map((_,i)=>(
                    <div key={i} className="relative">
                      {i === ( (params.politica.gargalo ?? 4) - 1) && params.politica.modo === "restricao" && (
                        <span className="absolute -top-2 left-1/2 -translate-x-1/2 text-[10px] px-1 py-0.5 rounded bg-cyan-600 text-white">Restr</span>
                      )}
                      <div className="rounded-xl border p-2 text-center">
                        <div className="text-xs font-semibold text-blue-700">Máquina {i+1}</div>
                        <div className="text-3xl font-mono">{estado.dados[i] || "·"}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="mt-4 space-y-2">
                <Row label="Estoque Anterior">
                  <Cell value={Number.isFinite(estado.visAntes?.[0]) ? (estado.visAntes?.[0]) : Infinity} infinity={params.politica.modo !== "restricao"} />
                  {(estado.visAntes?.slice(1) || []).map((b,i)=> <Cell key={i} value={b}/>)}
                </Row>
                <Row label="Produção">
                  {estado.producao.map((x,i)=> <Cell key={i} value={x}/>)}
                </Row>
                <Row label="Estoque Final">
                  <Cell value={0} muted />
                  {(estado.estoqueDepois.slice(1) || []).map((b,i)=> <Cell key={i} value={b}/>)}
                </Row>
              </div>
            </main>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
